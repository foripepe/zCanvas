"use strict";function zCanvas(t){t=t||{};var e="number"==typeof t.width?t.width:300,n="number"==typeof t.height?t.height:300;if(e<=0||n<=0)throw new Error("cannot construct a zCanvas without valid dimensions");this.DEBUG="boolean"==typeof t.debug&&t.debug,this._fps="number"==typeof t.fps?t.fps:60,this._renderInterval=1e3/this._fps,this._animate="boolean"==typeof t.animate&&t.animate,this._smoothing=!0,this._updateHandler="function"==typeof t.onUpdate?t.onUpdate:null,this._renderHandler=this.render.bind(this),this._lastRender=0,this._renderId=0,this._renderPending=!1,this._disposed=!1,this._children=[],this._element=document.createElement("canvas"),this._canvasContext=this._element.getContext("2d");var i=window.devicePixelRatio||1,s=this._canvasContext.webkitBackingStorePixelRatio||this._canvasContext.mozBackingStorePixelRatio||this._canvasContext.msBackingStorePixelRatio||this._canvasContext.oBackingStorePixelRatio||this._canvasContext.backingStorePixelRatio||1,r=i/s;this._HDPIscaleRatio=i!==s?r:1,this.setDimensions(e,n),this.preventEventBubbling(!1),this.addListeners(),this._animate&&this.render()}function applyOrigin(t,e){isLocalURL(t)||(e.crossOrigin="Anonymous")}function isReady(t){return!("boolean"==typeof t.complete&&!t.complete)&&!("undefined"!=typeof t.naturalWidth&&0===t.naturalWidth)}function onReady(t,e,n){function i(){isReady(t)?e():++r===s?("function"==typeof n&&n(),console.warn("Image could not be resolved. This shouldn't occur.")):window.requestAnimationFrame(i)}var s=60,r=0;i()}function isDataSource(t){var e=("string"==typeof t?t:t.src).substr(0,5);return"data:"===e||"blob:"===e}function getSize(t){return{width:t.width||t.naturalWidth,height:t.height||t.naturalHeight}}function isLocalURL(t){if("./"===t.substr(0,2)||0===t.indexOf(window.location.protocol+"//"+window.location.host))return!0;var e=t.split("#")[0].split("?")[0];if(e.indexOf(".html")>-1){var n=e.split("/"),i=n.length;e=e.split(n[i-1]).join("")}if(e){var s=e.match(/^http[s]?:/);if(Array.isArray(s)&&s.length>0)return!1}return!0}function wrapOutput(t){var e={image:t,size:null};return t instanceof window.HTMLImageElement&&(e.size=getSize(t)),e}function zSprite(t){if(t=t||{},"number"!=typeof t.width||"number"!=typeof t.height)throw new Error("cannot construct a zSprite without valid dimensions");"number"!=typeof t.x&&(t.x=0),"number"!=typeof t.y&&(t.y=0),this._children=[],this._disposed=!1,this.collidable="boolean"==typeof t.collidable&&t.collidable,this.hover=!1,this._mask="boolean"==typeof t.mask&&t.mask,this._bounds={left:0,top:0,width:t.width,height:t.height},this._parent=null,this._bitmap,this._bitmapReady=!1,this._draggable=!1,this._interactive=!1,this._keepInBounds=!1,this.isDragging=!1,t.bitmap&&this.setBitmap(t.bitmap),this.setX(t.x),this.setY(t.y)}function EventHandler(){this._eventMappings=[],this._disposed=!1}var EventHandler=require("./utils/EventHandler"),OOP=require("./utils/OOP");module.exports=zCanvas,zCanvas.extend=function(t){OOP.extend(t,zCanvas)},zCanvas.prototype.insertInPage=function(t){if(this._element.parentNode)throw new Error("zCanvas already present in DOM");t.appendChild(this._element)},zCanvas.prototype.getElement=function(){return this._element},zCanvas.prototype.preventEventBubbling=function(t){this._preventDefaults=t},zCanvas.prototype.addChild=function(t){var e=this._children.length;return e>0&&(t.last=this._children[e-1],t.last.next=t),t.next=null,t.setCanvas(this),t.setParent(this),this._children.push(t),this.invalidate(),this},zCanvas.prototype.removeChild=function(t){t.setParent(null),t.setCanvas(null);var e=this._children.indexOf(t);e!==-1&&this._children.splice(e,1);var n=t.last,i=t.next;return n&&(n.next=i),i&&(i.last=n),t.last=t.next=null,this.invalidate(),t},zCanvas.prototype.getChildAt=function(t){return this._children[t]},zCanvas.prototype.removeChildAt=function(t){return this.removeChild(this.getChildAt(t))},zCanvas.prototype.numChildren=function(){return this._children.length},zCanvas.prototype.getChildren=function(){return this._children},zCanvas.prototype.contains=function(t){return this._children.indexOf(t)>-1},zCanvas.prototype.invalidate=function(){this._animate||this._renderPending||(this._renderPending=!0,this._renderId=window.requestAnimationFrame(this._renderHandler))},zCanvas.prototype.getChildrenUnderPoint=function(t,e,n,i,s){for(var r=[],o=this._children.length,a=void 0,h=void 0,d=void 0,p=void 0,l=void 0;o--;)a=this._children[o],h=a.getX(),d=a.getY(),p=a.getWidth(),l=a.getHeight(),h<t+n&&h+p>t&&d<e+i&&d+l>e&&(!s||s&&a.collidable)&&r.push(a);return r},zCanvas.prototype.getFrameRate=function(){return this._fps},zCanvas.prototype.getRenderInterval=function(){return this._renderInterval},zCanvas.prototype.setSmoothing=function(t){var e=["imageSmoothingEnabled","mozImageSmoothingEnabled","oImageSmoothingEnabled","webkitImageSmoothingEnabled"],n=this._canvasContext;this._smoothing=t,window.requestAnimationFrame(function(){e.forEach(function(e){void 0!==n[e]&&(n[e]=t)})})},zCanvas.prototype.getWidth=function(){return this._width},zCanvas.prototype.getHeight=function(){return this._height},zCanvas.prototype.setDimensions=function(t,e){var n=this._HDPIscaleRatio;this._width=t,this._height=e,this._element.width=t*n,this._element.height=e*n,this._element.style.width=t+"px",this._element.style.height=e+"px",this._canvasContext.scale(n,n),this._smoothing===!1&&this.setSmoothing(this._smoothing),this.invalidate()},zCanvas.prototype.setBackgroundColor=function(t){this._bgColor=t},zCanvas.prototype.setAnimatable=function(t){var e=this._animate;this._animate=t,t&&!e&&this._renderHandler()},zCanvas.prototype.isAnimatable=function(){return this._animate},zCanvas.prototype.checkCollision=function(t,e,n,i,s,r,o,a,h){r=r||t.getX(),o=o||t.getY(),a=a||1,h=h||1;var d=t.getWidth(),p=t.getHeight(),l=this._canvasContext,u=function(t,r,o,a){for(var h=l.getImageData(t,r,o,a),d=void 0,p=0,u=o*a*4;p<u;p+=4){if(d=!1,"number"==typeof e&&(d=h.data[p]==e,!d))return!1;if("number"==typeof n&&(d=h.data[p+1]==n,!d))return!1;if("number"==typeof i&&(d=h.data[p+2]==i,!d))return!1;if("number"==typeof s&&(d=h.data[p+3]==s,!d))return!1;if(d)return!0}return!1},c=void 0,f=void 0;return c=u(r-a,o,a,p),f=u(r,o+p+h,d,h),c||(c=u(r+d+a,o,a,p)),f||(f=u(r,o-h,d,h)),c||f?c?f?3:1:2:0},zCanvas.prototype.dispose=function(){if(!this._disposed){this._disposed=!0,this.removeListeners(),this._animate=!1,window.cancelAnimationFrame(this._renderId);for(var t=this.numChildren();t--;)this._children[t].dispose();this._children=[]}},zCanvas.prototype.render=function(){var t=Date.now(),e=t-this._lastRender;if(this._renderPending=!1,e>this._renderInterval){this._lastRender=t-e%this._renderInterval;var n=this._canvasContext,i=void 0;if(n){this._bgColor?(n.fillStyle=this._bgColor,n.fillRect(0,0,this._width,this._height)):n.clearRect(0,0,this._width,this._height);var s="function"==typeof this._updateHandler;if(s&&this._updateHandler(t),this._children.length>0)for(i=this._children[0];i;)s||i.update(t),i.draw(n),i=i.next}}!this._disposed&&this._animate&&(this._renderPending=!0,this._renderId=window.requestAnimationFrame(this._renderHandler))},zCanvas.prototype.handleInteraction=function(t){var e=this._children.length,n=0,i=0,s=void 0,r=void 0,o=void 0;if(e>0)switch(s=this._children[e-1],t.type){default:if(r=t.touches.length>0?t.touches:t.changedTouches,r.length>0){var a=this.getCoordinate();n=r[0].pageX-a.x,i=r[0].pageY-a.y}for(;s;)s.handleInteraction(n,i,t),s=s.last;break;case"mousedown":case"mousemove":case"mouseup":for(;s&&!(o=s.handleInteraction(t.offsetX,t.offsetY,t));)s=s.last}this._preventDefaults&&(t.stopPropagation(),t.preventDefault()),this.invalidate()},zCanvas.prototype.addListeners=function(){this._eventHandler||(this._eventHandler=new EventHandler);var t=this.handleInteraction.bind(this);"ontouchstart"in window?(this._eventHandler.addEventListener(this._element,"touchstart",t),this._eventHandler.addEventListener(this._element,"touchmove",t),this._eventHandler.addEventListener(this._element,"touchend",t)):(this._eventHandler.addEventListener(this._element,"mousedown",t),this._eventHandler.addEventListener(this._element,"mousemove",t),this._eventHandler.addEventListener(window,"mouseup",t))},zCanvas.prototype.removeListeners=function(){this._eventHandler&&this._eventHandler.dispose(),this._eventHandler=null},zCanvas.prototype.getCoordinate=function(){for(var t=0,e=0,n=this._element;n.offsetParent;)t+=n.offsetLeft,e+=n.offsetTop,n=n.offsetParent;return t+=n.offsetLeft,e+=n.offsetTop,{x:t,y:e}};var EventHandler=require("./utils/EventHandler");module.exports={loadImage:function(t,e,n){if(n instanceof window.Image&&isReady(n))return void e(wrapOutput(n));var i=n instanceof window.Image?n:new window.Image,s=isDataSource(t),r=new EventHandler,o=function(t){r.dispose(),e(wrapOutput(i),new Error(t.type))},a=function(){r.dispose(),onReady(i,function(){return e(wrapOutput(i))})},h=/^((?!chrome|android).)*safari/i.test(window.navigator.userAgent);return s&&!h||(s||applyOrigin(t,i),r.addEventListener(i,"load",a),r.addEventListener(i,"error",o)),i.src=t,s&&e(wrapOutput(i)),i}};var OOP=require("./utils/OOP"),zLoader=require("./zLoader");module.exports=zSprite,zSprite.extend=function(t){OOP.extend(t,zSprite)},zSprite.prototype.last=null,zSprite.prototype.next=null,zSprite.prototype.canvas=null,zSprite.prototype.getDraggable=function(){return this._draggable},zSprite.prototype.setDraggable=function(t,e){this._draggable=t,this._keepInBounds=e||!1,t&&!this._interactive&&this.setInteractive(!0)},zSprite.prototype.getX=function(){return this._bounds.left},zSprite.prototype.setX=function(t){var e=t-this._bounds.left;if(this._bounds.left=this._constraint?t+this._constraint.left:t,this._children.length>0)for(var n=this._children[0];n;)n.isDragging||n.setX(n._bounds.left+e),n=n.next},zSprite.prototype.getY=function(){return this._bounds.top},zSprite.prototype.setY=function(t){var e=t-this._bounds.top;if(this._bounds.top=this._constraint?t+this._constraint.top:t,this._children.length>0)for(var n=this._children[0];n;)n.isDragging||n.setY(n._bounds.top+e),n=n.next},zSprite.prototype.getWidth=function(){return this._bounds.width},zSprite.prototype.setWidth=function(t){var e=this._bounds.width||0;this._bounds.width=t,0!==e&&(this._bounds.left-=.5*t-.5*e)},zSprite.prototype.getHeight=function(){return this._bounds.height},zSprite.prototype.setHeight=function(t){var e=this._bounds.height||0;this._bounds.height=t,0!==e&&(this._bounds.top-=.5*t-.5*e)},zSprite.prototype.getBounds=function(){return this._bounds},zSprite.prototype.getInteractive=function(){return this._interactive},zSprite.prototype.setInteractive=function(t){this._interactive=t},zSprite.prototype.update=function(t){if(this._children.length>0)for(var e=this._children[0];e;)e.update(t),e=e.next},zSprite.prototype.updatePosition=function(t,e){if("number"!=typeof t&&(t=this._bounds.left),"number"!=typeof e&&(e=this._bounds.top),this._constraint)t-=this._constraint.left,e-=this._constraint.top;else if(!this.canvas)throw new Error("cannot update position of a zSprite that has no constraint or is not added to a zCanvas");var n=this._bounds.width,i=this._bounds.height,s=this._constraint?this._constraint.width:this.canvas.width,r=this._constraint?this._constraint.height:this.canvas.height;if(this._keepInBounds){var o=Math.min(0,-(n-s)),a=Math.min(0,-(i-r)),h=s-n,d=r-i;t=Math.min(h,Math.max(t,o)),e=Math.min(d,Math.max(e,a))}else t>s&&(t+=.5*n),e>r&&(e+=.5*i);this.setX(t),this.setY(e)},zSprite.prototype.draw=function(t){if(t.save(),this._mask&&(t.globalCompositeOperation="destination-in"),this._bitmapReady){var e=this._bounds;t.drawImage(this._bitmap,e.left,e.top,e.width,e.height)}if(this._children.length>0)for(var n=this._children[0];n;)n.draw(t),n=n.next;this._mask&&(t.globalCompositeOperation="source-over"),t.restore(),this.canvas.DEBUG&&this.drawOutline(t)},zSprite.prototype.collidesWith=function(t){if(t==this)return!1;var e=t.getX(),n=t.getY(),i=t.getWidth(),s=t.getHeight(),r=this.getX(),o=this.getY(),a=this.getWidth(),h=this.getHeight();return e<r+a&&e+i>r&&n<o+h&&n+s>o},zSprite.prototype.collidesWithEdge=function(t,e){if(t===this)return!1;if(isNaN(e)||e<0||e>3)throw new Error("invalid argument for edge");switch(e){case 0:return this.getX()<=t.getX()+t.getWidth();case 1:return this.getY()<=t.getY()+t.getHeight();case 2:return this.getX()+this.getWidth()<=t.getX();case 3:return this.getY()+this.getHeight()>=t.getY()}return!1},zSprite.prototype.setBitmap=function(t){var e=this;if(this._bitmap!==t&&(this._bitmapReady=!1),t||(this._bitmap=null),t)if(t instanceof window.HTMLCanvasElement)this._bitmap=t,this._bitmapReady=!0;else{if(!(t instanceof window.HTMLImageElement||"string"==typeof t))throw new Error("expected HTMLImageElement, HTMLCanvasElement or String for Image source, got "+t+" instead");!function(){var n=e;zLoader.loadImage(t,function(t,e){if(e instanceof Error)console.error(e.message+" occurred. Could not setBitmap()");else if(n._bitmap=t.image,n._bitmapReady=!0,n.setWidth(t.size.width),n.setHeight(t.size.height),n._keepInBounds&&n.canvas){var i=-(n._bounds.width-n.canvas.getWidth()),s=-(n._bounds.height-n.canvas.getHeight());n._bounds.left>0?n._bounds.left=0:n._bounds.left<i&&(n._bounds.left=i),n._bounds.top>0?n._bounds.top=0:n._bounds.top<s&&(n._bounds.top=s)}})}()}},zSprite.prototype.setParent=function(t){this._parent=t},zSprite.prototype.getParent=function(){return this._parent},zSprite.prototype.setCanvas=function(t){this.canvas=t,!this._constraint&&t&&this.setConstraint(0,0,t.getWidth(),t.getHeight())},zSprite.prototype.setConstraint=function(t,e,n,i){return this._constraint={left:t,top:e,width:n,height:i},this._bounds.left=Math.max(t,this._bounds.left),this._bounds.top=Math.max(e,this._bounds.top),this._keepInBounds=!0,this._constraint},zSprite.prototype.getConstraint=function(){return this._constraint},zSprite.prototype.addChild=function(t){var e=this._children.length;return e>0&&(t.last=this._children[e-1],t.last.next=t,t.next=null),t.setCanvas(this.canvas),t.setParent(this),this._children.push(t),this.canvas&&this.canvas.invalidate(),this},zSprite.prototype.removeChild=function(t){t.setParent(null),t.setCanvas(null);var e=this._children.indexOf(t);e!==-1&&this._children.splice(e,1);var n=t.last,i=t.next;return n&&(n.next=i),i&&(i.last=n),t.last=t.next=null,this.canvas&&this.canvas.invalidate(),t},zSprite.prototype.getChildAt=function(t){return this._children[t]},zSprite.prototype.removeChildAt=function(t){return this.removeChild(this.getChildAt(t))},zSprite.prototype.numChildren=function(){return this._children.length},zSprite.prototype.contains=function(t){return this._children.indexOf(t)>-1},zSprite.prototype.handlePress=function(t,e){},zSprite.prototype.handleRelease=function(t,e){},zSprite.prototype.handleClick=function(){},zSprite.prototype.handleMove=function(t,e){var n=this._dragStartOffset.x+(t-this._dragStartEventCoordinates.x),i=this._dragStartOffset.y+(e-this._dragStartEventCoordinates.y);this.updatePosition(n,i)},zSprite.prototype.handleInteraction=function(t,e,n){var i=!1,s=void 0,r=this.getX(),o=this.getY(),a=this._children.length;if(a>0)for(s=this._children[a-1];s;){if(i=s.handleInteraction(t,e,n))return!0;s=s.last}if(!this._interactive)return!1;if(this.isDragging&&("touchend"===n.type||"mouseup"===n.type))return this.isDragging=!1,Date.now()-this._dragStartTime<250&&this.handleClick(),this.handleRelease(t,e),!0;var h=this._bounds;if(t>=r&&t<=r+h.width&&e>=o&&e<=o+h.height){if(this.hover=!0,!this.isDragging&&("touchstart"===n.type||"mousedown"===n.type))return this.isDragging=!0,this._dragStartTime=Date.now(),this._dragStartOffset={x:this._bounds.left,y:this._bounds.top},this._dragStartEventCoordinates={x:t,y:e},this.handlePress(t,e),!0}else this.hover=!1;return!(!this._draggable||!this.isDragging)&&(this.handleMove(t,e),!0)},zSprite.prototype.dispose=function(){if(!this._disposed){this._disposed=!0,this._parent&&this._parent.removeChild(this);for(var t=this._children.length;t--;){var e=this._children[t];e.dispose(),e.next=e.last=null}this._children=[]}},zSprite.prototype.drawOutline=function(t){t.lineWidth=1,t.strokeStyle="#FF0000",t.strokeRect(this.getX(),this.getY(),this.getWidth(),this.getHeight())},module.exports=EventHandler,EventHandler.prototype.addEventListener=function(t,e,n){if(!this.hasEventListener(t,e)){if(t.addEventListener)t.addEventListener(e,n,!1);else{if(!t.attachEvent)return!1;t.attachEvent("on"+e,n)}return this._eventMappings.push({element:t,type:e,listener:n}),!0}return!1},EventHandler.prototype.hasEventListener=function(t,e){for(var n=this._eventMappings.length;n--;){var i=this._eventMappings[n];if(i.element===t&&i.type==e)return!0}return!1},EventHandler.prototype.removeEventListener=function(t,e){for(var n=this._eventMappings.length;n--;){var i=this._eventMappings[n];if(i.element===t&&i.type===e){if(t.removeEventListener)t.removeEventListener(e,i.listener,!1);else{if(!t.detachEvent)return!1;t.detachEvent("on"+e,i.listener)}return this._eventMappings.splice(n,1),!0}}return!1},EventHandler.prototype.dispose=function(){if(!this._disposed){this._disposed=!0;for(var t=this._eventMappings.length;t--;){var e=this._eventMappings[t];this.removeEventListener(e.element,e.type)}this._eventMappings=null}};var OOP=module.exports={extend:function(t,e){function n(){}n.prototype=e.prototype,t.superClass_=e.prototype,t.prototype=new n,t.prototype.constructor=t,t.super=function(t,n,i){for(var s=new Array(arguments.length-2),r=2;r<arguments.length;r++)s[r-2]=arguments[r];return e.prototype[n].apply(t,s)},t.extend=function(e){OOP.extend(e,t)}}};